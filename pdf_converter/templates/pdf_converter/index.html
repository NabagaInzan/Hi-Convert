<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hi Convert - Traitement PDF</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Roboto', sans-serif;
        }
        .container {
            max-width: 1200px;
            margin-top: 2rem;
        }
        .folder-select {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .progress {
            height: 25px;
        }
        .table {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .job-card {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .download-btn {
            color: #0d6efd;
            cursor: pointer;
        }
        .download-btn:hover {
            color: #0a58ca;
        }
        #nativeFolderInput {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">Hi Convert</h1>
        
        <div class="folder-select">
            <form id="folderForm" class="mb-3">
                <div class="mb-3">
                    <label for="folderPath" class="form-label">Sélectionnez un dossier</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="folderPath" name="folder_path" readonly>
                        <button class="btn btn-outline-secondary" type="button" id="browseButton">
                            <i class="bi bi-folder2-open"></i> Parcourir
                        </button>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" id="startButton" disabled>
                    <i class="bi bi-play-fill"></i> Démarrer le traitement
                </button>
                <button type="button" class="btn btn-danger" id="cancelButton" style="display: none;">
                    <i class="bi bi-x-circle"></i> Annuler
                </button>
            </form>
            
            <div id="progressArea" style="display: none;">
                <div class="progress mb-2">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                </div>
                <p id="statusText" class="mt-2"></p>
            </div>
        </div>

        <div id="jobsList">
            <h3>Traitements en cours et terminés</h3>
            {% for job in jobs %}
            <div class="job-card">
                <h5>Traitement #{{ job.id }}</h5>
                <p>Dossier: {{ job.folder_path }}</p>
                <p>Status: {{ job.status }}</p>
                <p>Fichiers traités: {{ job.processed_count }}/{{ job.total_files }}</p>
                {% if job.total_processing_time %}
                <p>Temps total: {{ job.total_processing_time|floatformat:2 }} secondes</p>
                {% endif %}
                
                {% if job.files.all %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Fichier</th>
                                <th>Status</th>
                                <th>Temps de traitement</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for file in job.files.all %}
                            <tr>
                                <td>{{ file.file_path }}</td>
                                <td>{{ file.status }}</td>
                                <td>{{ file.processing_time|floatformat:2 }}s</td>
                                <td>
                                    {% if file.status == 'completed' %}
                                    <a href="{% url 'download_csv' file.id %}" class="download-btn" title="Télécharger CSV">
                                        <i class="bi bi-download"></i>
                                    </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            let currentJobId = null;
            let isProcessing = false;

            // Fonction pour ouvrir le sélecteur de dossier natif
            $('#browseButton').click(async function() {
                try {
                    // Créer un élément input file temporaire
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.setAttribute('webkitdirectory', '');
                    input.setAttribute('directory', '');
                    input.setAttribute('multiple', '');
                    
                    // Promesse pour attendre la sélection du dossier
                    const files = await new Promise((resolve) => {
                        input.onchange = (e) => resolve(Array.from(e.target.files));
                        input.click();
                    });

                    if (files && files.length > 0) {
                        // Récupérer le chemin complet du premier fichier
                        const fullPath = files[0].webkitRelativePath;
                        const folderPath = fullPath.substring(0, fullPath.lastIndexOf('/'));
                        const selectedPath = prompt(
                            'Veuillez confirmer ou modifier le chemin complet du dossier:',
                            'C:\\Users\\HP\\Desktop\\Inza Files\\AFOR\\ARRAH\\ARRAH\\' + folderPath
                        );
                        
                        if (selectedPath) {
                            $('#folderPath').val(selectedPath);
                            $('#startButton').prop('disabled', false);
                            console.log('Dossier sélectionné:', selectedPath);
                        }
                    }
                } catch (error) {
                    console.error('Erreur lors de la sélection du dossier:', error);
                    alert('Erreur lors de la sélection du dossier');
                }
            });

            // Fonction pour télécharger un fichier CSV
            $('.download-csv').click(function(e) {
                e.preventDefault();
                const fileId = $(this).data('file-id');
                window.location.href = `/download-csv/${fileId}`;
            });

            $('#folderForm').on('submit', function(e) {
                e.preventDefault();
                
                const folderPath = $('#folderPath').val();
                if (!folderPath) {
                    alert('Veuillez sélectionner un dossier');
                    return;
                }

                console.log('Envoi du dossier:', folderPath);

                isProcessing = true;
                $('#startButton').prop('disabled', true);
                $('#cancelButton').show();
                $('#progressArea').show();
                $('.progress-bar').css('width', '0%');
                $('#statusText').text('Démarrage du traitement...');
                
                $.ajax({
                    url: '/process-folder/',
                    type: 'POST',
                    data: {
                        'folder_path': folderPath
                    },
                    success: function(response) {
                        console.log('Réponse du serveur:', response);
                        if (response.status === 'success') {
                            currentJobId = response.job_id;
                            checkJobStatus(response.job_id);
                        } else {
                            $('#statusText').text(response.message);
                            resetUI();
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Erreur:', error);
                        $('#statusText').text('Erreur lors du démarrage du traitement');
                        resetUI();
                    }
                });
            });

            $('#cancelButton').click(function() {
                isProcessing = false;
                resetUI();
                $('#statusText').text('Traitement annulé');
                setTimeout(function() {
                    $('#progressArea').hide();
                }, 2000);
            });
            
            function checkJobStatus(jobId) {
                if (!isProcessing) return;
                
                $.get('/job-status/' + jobId, function(response) {
                    if (response.status === 'completed') {
                        $('.progress-bar').css('width', '100%');
                        $('#statusText').text('Traitement terminé en ' + response.total_processing_time.toFixed(2) + ' secondes');
                        resetUI();
                        setTimeout(function() {
                            location.reload();
                        }, 2000);
                    } else if (response.status === 'failed') {
                        $('#statusText').text('Erreur lors du traitement');
                        resetUI();
                    } else if (response.status === 'no_files') {
                        $('#statusText').text('Aucun fichier plan.pdf trouvé dans le dossier sélectionné');
                        resetUI();
                        setTimeout(function() {
                            $('#progressArea').hide();
                        }, 3000);
                    } else {
                        const progress = (response.processed_files / response.total_files) * 100;
                        $('.progress-bar').css('width', progress + '%');
                        $('#statusText').text('Traitement en cours: ' + response.processed_files + '/' + response.total_files + ' fichiers');
                        if (isProcessing) {
                            setTimeout(function() {
                                checkJobStatus(jobId);
                            }, 1000);
                        }
                    }
                });
            }

            function resetUI() {
                isProcessing = false;
                currentJobId = null;
                $('#startButton').prop('disabled', false);
                $('#cancelButton').hide();
            }
        });
    </script>
</body>
</html>
